---
phase: 07-bulk-processing
plan: 04
type: execute
---

<objective>
Implement live batch progress tracking page and email notification on completion.

Purpose: Let users watch batch progress in real-time or opt for email notification when complete.
Output: Working progress page with live updates and optional email notification.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**From 07-01 (Auth):**
@src/lib/auth.ts
@src/app/auth/signup/page.tsx

**From 07-02 (Upload) and 07-03 (Queue):**
@src/app/dashboard/bulk/page.tsx
@src/app/dashboard/bulk/actions.ts
@src/lib/batch-processor.ts
@prisma/schema.prisma (User, BatchJob, BatchQuote models)

**Existing files:**
@src/app/quote/[id]/page.tsx (polling pattern for status updates)
@src/lib/email.ts (email sending pattern)
@src/app/dashboard/page.tsx (dashboard patterns)

**Constraining decisions:**
- Use polling for status updates (matches existing pattern)
- Email notification optional (user checkbox)
- Must be authenticated to view batch progress
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create batch progress page with live updates</name>
  <files>src/app/dashboard/bulk/[id]/page.tsx, src/app/dashboard/bulk/actions.ts</files>
  <action>
1. Add action to src/app/dashboard/bulk/actions.ts:
   - getBatchJobWithQuotes(batchJobId: string): Full batch job with all BatchQuote records
   - Verify user owns this batch job (security check)

2. Create batch progress page at src/app/dashboard/bulk/[id]/page.tsx:
   - Load batch job data on mount
   - Show header: "Batch Progress" with user's company name
   - Show overall progress:
     * Visual progress bar (0-100%)
     * "X of Y addresses processed"
     * "Currently processing: [address]" (when processing)
   - Show summary stats:
     * Total addresses
     * Successful quotes (count)
     * Failed quotes (count)
   - Show table of all addresses:
     * Row #, Address, Status, Price (if complete)
     * Status badges: pending (gray), processing (blue pulse), complete (green), failed (red)
     * Click row to view individual quote (if complete)

   - Polling: If status != "complete", poll every 10 seconds
   - When complete, show "Batch Complete!" message with confetti or celebration

   Style: Match existing quote status page patterns (dark theme, cards, progress bar animation)
  </action>
  <verify>
- Navigate to /dashboard/bulk/[id] shows progress
- Progress bar updates as quotes complete
- Individual quote statuses visible
  </verify>
  <done>
- Batch progress page with live polling
- Visual progress bar
- Individual address status table
- Auto-updates every 10 seconds
  </done>
</task>

<task type="auto">
  <name>Task 2: Add email notification checkbox and completion email</name>
  <files>src/app/dashboard/bulk/page.tsx, src/lib/email.ts, src/lib/batch-processor.ts</files>
  <action>
1. Update bulk upload page (src/app/dashboard/bulk/page.tsx):
   - Add checkbox: "Email me when complete" (default: checked)
   - Use user's email from session (show it grayed out)
   - Include notifyEmail in form submission
   - After submission, redirect to progress page

2. Add batch completion email to src/lib/email.ts:
   - Export sendBatchCompleteEmail(data: BatchEmailData)
   - BatchEmailData: { to, customerName, company, batchJobId, totalCount, successCount, failedCount, quotes: { address, mrc, status }[] }
   - Template similar to quote email but for batch:
     * "Your Bulk Quote Results Are Ready"
     * Summary: X successful, Y failed
     * Table showing each address with price (if success) or error (if failed)
     * CTA: "View Full Results" linking to dashboard/bulk/[id]

3. Update batch processor (src/lib/batch-processor.ts):
   - After batch completes, if notifyEmail is true:
     * Fetch batch job with user info
     * Call sendBatchCompleteEmail
   - Log email sending (don't fail batch if email fails)

4. Add "Bulk Upload" button/link to dashboard page (src/app/dashboard/page.tsx):
   - Next to "New Quote" button, add "Bulk Upload" link
   - Link goes to /auth/login if not logged in, /dashboard/bulk if logged in
  </action>
  <verify>
- Checkbox appears on upload page
- Submitting with checkbox checked triggers email on completion
- Dashboard has link to bulk upload
  </verify>
  <done>
- Email notification toggle on upload page
- Batch completion email sent when opted in
- Dashboard has bulk upload link
- Phase 7 complete
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Batch progress page shows live updates
- [ ] Progress bar animates correctly
- [ ] Email checkbox works
- [ ] Completion email sent when enabled
- [ ] Dashboard links to bulk upload
- [ ] Full batch flow works end-to-end
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Live progress tracking functional
- Email notification working
- Bulk processing feature complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-bulk-processing/07-04-SUMMARY.md` with:
- Summary of bulk processing feature
- All files created/modified
- Decisions made during implementation
- Phase 7 complete status
</output>
