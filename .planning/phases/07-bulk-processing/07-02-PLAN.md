---
phase: 07-bulk-processing
plan: 02
type: execute
---

<objective>
Implement spreadsheet upload with file parsing and address validation preview.

Purpose: Enable authenticated users to upload CSV/Excel files with multiple business addresses for bulk quoting.
Output: Working upload interface with parsed address preview and validation before submission.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**From 07-01:**
@src/lib/auth.ts
@src/middleware.ts (protects /dashboard/bulk)
@prisma/schema.prisma (User model)

**Existing files to reference:**
@src/app/quote/page.tsx (single quote form for patterns)
@src/app/dashboard/page.tsx (dashboard patterns)
@src/lib/validations/quote.ts (validation patterns)

**Tech stack available:**
- Next.js 16 with App Router
- Prisma with SQLite
- shadcn/ui components
- React Hook Form + Zod
- Authentication via JWT cookies

**Constraining decisions:**
- Route protected by auth middleware
- Momentum API supports only 1 concurrent request (queue required)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add xlsx parsing dependency and create upload UI</name>
  <files>package.json, src/app/dashboard/bulk/page.tsx, src/components/file-dropzone.tsx</files>
  <action>
1. Install xlsx library: `npm install xlsx`

2. Create file dropzone component at src/components/file-dropzone.tsx:
   - Accept .csv and .xlsx files
   - Drag-and-drop zone with click-to-browse fallback
   - File size validation (max 5MB)
   - Show file name and size after selection
   - Styled to match dark theme (bg-[#12121a], border-dashed, etc.)

3. Create bulk upload page at src/app/dashboard/bulk/page.tsx:
   - Get current user from session (show welcome message with name)
   - Page title "Bulk Quote Upload"
   - FileDropzone component
   - "Upload & Preview" button (disabled until file selected)
   - Link back to dashboard
   - Show user's company name in header

Use shadcn patterns from existing components. DO NOT use react-dropzone - implement with native HTML5 drag-drop API to avoid extra dependencies.
  </action>
  <verify>
- npm run build succeeds
- Navigate to /dashboard/bulk shows upload UI (requires login)
- Can select .csv or .xlsx file
- User info displayed on page
  </verify>
  <done>
- xlsx installed in package.json
- FileDropzone component renders with drag-drop support
- /dashboard/bulk page shows upload interface
- Protected route works (redirects if not logged in)
  </done>
</task>

<task type="auto">
  <name>Task 2: Parse spreadsheet and show address preview table</name>
  <files>src/app/dashboard/bulk/page.tsx, src/app/dashboard/bulk/actions.ts, src/lib/spreadsheet-parser.ts</files>
  <action>
1. Create spreadsheet parser at src/lib/spreadsheet-parser.ts:
   - Export parseSpreadsheet(buffer: ArrayBuffer): ParsedRow[]
   - Handle both CSV and XLSX formats using xlsx library
   - Expected columns: street_address (or address), city, state, zip (or zip_code, postal_code)
   - Normalize column names (case-insensitive, handle common variations)
   - Return array of { streetAddress, city, state, zipCode, rowNumber, isValid, errors[] }
   - Validate each row: all 4 fields required, state is 2 chars, zip is 5 digits
   - Max 100 rows per upload

2. Create server action at src/app/dashboard/bulk/actions.ts:
   - parseUploadedFile(formData: FormData): { rows: ParsedRow[], validCount: number, invalidCount: number }
   - Use the spreadsheet parser
   - Return validation summary

3. Update bulk page to show preview:
   - After file selected and "Preview" clicked, call parseUploadedFile
   - Show table with columns: Row #, Address, City, State, Zip, Status
   - Valid rows: green checkmark
   - Invalid rows: red X with error tooltip
   - Summary: "X valid addresses, Y invalid"
   - "Submit Valid Addresses" button (disabled if no valid rows)

Style the table using shadcn Table component matching dashboard patterns.
  </action>
  <verify>
- Upload a CSV with addresses, see preview table
- Invalid rows show errors
- Valid/invalid count displayed
  </verify>
  <done>
- Spreadsheet parser handles CSV and XLSX
- Preview shows all rows with validation status
- User can see which rows will be processed
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] /dashboard/bulk page loads (when authenticated)
- [ ] Can upload CSV file and see preview
- [ ] Can upload XLSX file and see preview
- [ ] Invalid rows are clearly marked
- [ ] Valid row count matches expectations
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Bulk upload UI functional with file parsing
- Address validation preview working
</success_criteria>

<output>
After completion, create `.planning/phases/07-bulk-processing/07-02-SUMMARY.md`
</output>
