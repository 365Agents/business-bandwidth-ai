---
phase: 07-bulk-processing
plan: 02
type: execute
---

<objective>
Implement batch job tracking and sequential queue processor for bulk quote requests.

Purpose: Enable processing of multiple addresses through Momentum API one at a time while tracking overall batch progress.
Output: Working queue system that processes addresses sequentially and updates batch job status.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**From 07-01:**
@src/app/dashboard/bulk/page.tsx
@src/lib/spreadsheet-parser.ts
@src/app/dashboard/bulk/actions.ts

**Existing files:**
@prisma/schema.prisma
@src/lib/momentum-api.ts (existing Momentum integration)
@src/app/quote/actions.ts (submitQuoteRequest pattern)

**Constraining decisions:**
- Momentum API: 1 concurrent request only
- Quote polling takes 2-3 minutes per address
- Lead capture required per quote
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BatchJob and BatchQuote models to database schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add two new models to track batch operations:

```prisma
model BatchJob {
  id            String       @id @default(cuid())
  leadId        String
  lead          Lead         @relation(fields: [leadId], references: [id])
  status        String       @default("pending") // pending, processing, complete, failed
  totalCount    Int          // Total addresses in batch
  processedCount Int         @default(0) // How many processed so far
  successCount  Int          @default(0) // How many got quotes
  failedCount   Int          @default(0) // How many failed
  currentIndex  Int          @default(0) // Current position being processed
  fileName      String?      // Original uploaded file name
  notifyEmail   Boolean      @default(false) // Send email when complete
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  quotes        BatchQuote[]
}

model BatchQuote {
  id            String    @id @default(cuid())
  batchJobId    String
  batchJob      BatchJob  @relation(fields: [batchJobId], references: [id])
  quoteId       String?   // Link to Quote once created
  quote         Quote?    @relation(fields: [quoteId], references: [id])
  rowNumber     Int       // Row from spreadsheet
  streetAddress String
  city          String
  state         String
  zipCode       String
  status        String    @default("pending") // pending, processing, complete, failed
  errorMessage  String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}
```

Also add to Lead model:
```prisma
  batchJobs BatchJob[]
```

And to Quote model:
```prisma
  batchQuotes BatchQuote[]
```

Run `npx prisma db push` to update the database.
  </action>
  <verify>
- npx prisma validate passes
- npx prisma db push succeeds
- npx prisma generate creates types
  </verify>
  <done>
- BatchJob model with status tracking fields
- BatchQuote model linking batch items to quotes
- Relations properly defined
- Database schema updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create batch submission and queue processor</name>
  <files>src/app/dashboard/bulk/actions.ts, src/lib/batch-processor.ts</files>
  <action>
1. Update src/app/dashboard/bulk/actions.ts to add:
   - submitBatchJob(formData: FormData): { batchJobId: string } | { error: string }
   - Creates Lead record (or reuses if email matches)
   - Creates BatchJob with totalCount
   - Creates BatchQuote records for each valid row (status="pending")
   - Kicks off background processing by calling processBatchJob
   - Returns batchJobId for redirect to progress page

2. Create src/lib/batch-processor.ts:
   - Export async function processBatchJob(batchJobId: string)
   - Get batch job with pending BatchQuotes
   - For each BatchQuote (sequentially, NOT in parallel):
     a. Update BatchQuote status to "processing"
     b. Update BatchJob currentIndex
     c. Create Quote record using existing quote submission logic
     d. Submit to Momentum API
     e. Poll for completion (reuse checkQuoteStatus logic)
     f. Update BatchQuote with result (status, link to Quote)
     g. Update BatchJob counters (processedCount, successCount/failedCount)
   - After all complete:
     a. Update BatchJob status to "complete"
     b. If notifyEmail is true, send completion email

   IMPORTANT: Process ONE quote at a time. Do NOT parallelize.
   Use try/catch around each quote to continue on individual failures.

3. Add server action to get batch status:
   - getBatchJobStatus(batchJobId: string): BatchJob with quotes
  </action>
  <verify>
- Submit a batch with 2-3 test addresses
- Watch logs show sequential processing
- BatchJob counters update correctly
  </verify>
  <done>
- Batch submission creates all records
- Queue processes addresses one at a time
- Status tracked at both batch and individual quote level
- Failures don't stop the batch
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx prisma validate` passes
- [ ] BatchJob and BatchQuote models in schema
- [ ] Can submit a batch from the bulk upload page
- [ ] Queue processes addresses sequentially
- [ ] BatchJob status updates as quotes complete
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Batch job tracking working
- Sequential queue processor functional
</success_criteria>

<output>
After completion, create `.planning/phases/07-bulk-processing/07-02-SUMMARY.md`
</output>
