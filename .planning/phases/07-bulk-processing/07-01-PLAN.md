---
phase: 07-bulk-processing
plan: 01
type: execute
---

<objective>
Implement user authentication system for bulk upload access with business profile info.

Purpose: Gate bulk upload behind free account creation to capture detailed user profiles (agent vs end user, business name, etc.).
Output: Working signup/login system with protected bulk upload route.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing files:**
@prisma/schema.prisma
@src/app/dashboard/page.tsx
@src/lib/db.ts

**Tech stack available:**
- Next.js 16 with App Router
- Prisma with SQLite
- shadcn/ui components
- React Hook Form + Zod

**Constraining decisions:**
- Lightweight auth (no external providers like Clerk/Auth0)
- Use bcrypt for password hashing, jose for JWT
- Session stored in httpOnly cookie
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add User model and auth dependencies</name>
  <files>prisma/schema.prisma, package.json</files>
  <action>
1. Install auth dependencies: `npm install bcryptjs jose` and `npm install -D @types/bcryptjs`

2. Add User model to prisma/schema.prisma:
```prisma
model User {
  id            String     @id @default(cuid())
  email         String     @unique
  passwordHash  String
  name          String
  company       String
  phone         String?
  userType      String     // "agent" or "end_user"
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  batchJobs     BatchJob[]
}
```

3. Update BatchJob model to reference User instead of Lead:
```prisma
model BatchJob {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  // ... rest of fields unchanged
}
```

4. Run `npx prisma db push` to update schema.

Note: Keep Lead model for single quotes (anonymous users). User model is for authenticated bulk upload users.
  </action>
  <verify>
- npx prisma validate passes
- npx prisma db push succeeds
- User model has all required fields
  </verify>
  <done>
- bcryptjs and jose installed
- User model with email, company, userType fields
- BatchJob linked to User
- Database updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth API routes and middleware</name>
  <files>src/app/api/auth/signup/route.ts, src/app/api/auth/login/route.ts, src/app/api/auth/logout/route.ts, src/lib/auth.ts, src/middleware.ts</files>
  <action>
1. Create auth utilities at src/lib/auth.ts:
   - JWT secret from process.env.JWT_SECRET (default to dev key if not set)
   - createToken(userId: string): Promise<string> - creates JWT with jose, 7 day expiry
   - verifyToken(token: string): Promise<{ userId: string } | null>
   - hashPassword(password: string): Promise<string> - bcrypt hash
   - comparePassword(password, hash): Promise<boolean>
   - getSession(cookies): Promise<User | null> - gets user from JWT cookie

2. Create signup API at src/app/api/auth/signup/route.ts:
   - POST accepts: { email, password, name, company, phone?, userType }
   - Validate with zod: email format, password min 8 chars, userType enum
   - Check email not already registered
   - Hash password, create User
   - Create JWT, set httpOnly cookie "session"
   - Return { success: true, user: { id, email, name, company } }

3. Create login API at src/app/api/auth/login/route.ts:
   - POST accepts: { email, password }
   - Find user by email
   - Compare password
   - Create JWT, set cookie
   - Return user info or 401

4. Create logout API at src/app/api/auth/logout/route.ts:
   - POST clears the session cookie
   - Return { success: true }

5. Create middleware at src/middleware.ts:
   - Protect /dashboard/bulk/* routes
   - Check for valid session cookie
   - Redirect to /auth/login if not authenticated
   - Allow other routes to pass through

Cookie settings: httpOnly, secure in production, sameSite: 'lax', path: '/', maxAge: 7 days
  </action>
  <verify>
- POST /api/auth/signup creates user and sets cookie
- POST /api/auth/login authenticates and sets cookie
- /dashboard/bulk redirects to login when not authenticated
  </verify>
  <done>
- Signup/login/logout API routes working
- JWT-based session management
- Middleware protects bulk upload routes
  </done>
</task>

<task type="auto">
  <name>Task 3: Create signup and login UI pages</name>
  <files>src/app/auth/signup/page.tsx, src/app/auth/login/page.tsx, src/app/auth/layout.tsx, src/lib/validations/auth.ts</files>
  <action>
1. Create auth validation schema at src/lib/validations/auth.ts:
   - signupSchema: email, password (min 8), name, company, phone (optional), userType (enum: agent, end_user)
   - loginSchema: email, password

2. Create auth layout at src/app/auth/layout.tsx:
   - Centered card layout
   - NetworkGPT logo at top
   - Dark theme matching rest of app

3. Create signup page at src/app/auth/signup/page.tsx:
   - Form with fields:
     * Email (required)
     * Password (required, min 8 chars)
     * Full Name (required)
     * Company/Business Name (required)
     * Phone (optional)
     * User Type: Radio buttons - "I'm a sales agent" or "I'm getting quotes for my business"
   - Submit calls /api/auth/signup
   - On success, redirect to /dashboard/bulk
   - Show errors inline
   - Link to login page: "Already have an account? Log in"

4. Create login page at src/app/auth/login/page.tsx:
   - Email and password fields
   - Submit calls /api/auth/login
   - On success, redirect to /dashboard/bulk
   - Link to signup: "Don't have an account? Sign up free"

Style: Match existing dark theme. Use shadcn form components. Add subtle gradient on submit button.
  </action>
  <verify>
- /auth/signup shows registration form
- /auth/login shows login form
- Can create account and get redirected
- Can login and get redirected
  </verify>
  <done>
- Signup page with all profile fields
- Login page
- User type selection (agent vs end user)
- Redirect flow working
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Can sign up with email/password
- [ ] Can log in with credentials
- [ ] /dashboard/bulk redirects to login when not authenticated
- [ ] After login, can access /dashboard/bulk
- [ ] User profile includes company and userType
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- No TypeScript errors
- Authentication system functional
- User profiles capture business info and user type
</success_criteria>

<output>
After completion, create `.planning/phases/07-bulk-processing/07-01-SUMMARY.md`
</output>
